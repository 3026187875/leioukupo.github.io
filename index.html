<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>leioukupo的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="记录学习琐事,讲述生活小事">
<meta property="og:type" content="website">
<meta property="og:title" content="leioukupo的博客">
<meta property="og:url" content="https://blog.leioukupo.top/index.html">
<meta property="og:site_name" content="leioukupo的博客">
<meta property="og:description" content="记录学习琐事,讲述生活小事">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="leioukupo">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="leioukupo的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">leioukupo的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">享受生活,致力学习</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.leioukupo.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-PVE备份与恢复" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/PVE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T00:30:44.067Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pve/">pve</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/PVE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/">PVE备份与恢复</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="PVE的备份和恢复"><a href="#PVE的备份和恢复" class="headerlink" title="PVE的备份和恢复"></a>PVE的备份和恢复</h1><p>进入pve管理后台，在各虚拟机的备份选项点击备份</p>
<p>备份文件路径是<em>Var&#x2F;lib&#x2F;vz&#x2F;dump</em>，下载到其他地方保持</p>
<p>需要恢复时将备份文件上传到<em>Var&#x2F;lib&#x2F;vz&#x2F;dump</em>，在存储 local里点击对应的备份文件进行还原，然后启动虚拟机</p>
<p>！！！如果启动虚拟机时提示找不到iso镜像，找到硬件选项，编辑CD&#x2F;DVD驱动器重新选择一下iso镜像文件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2025/01/24/PVE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" data-id="cm6a108vh0007i4q861a42n09" data-title="PVE备份与恢复" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pve/" rel="tag">pve</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Next-chat-web同步问题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/31/Next-chat-web%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2024-12-31T02:11:58.863Z" itemprop="datePublished">2024-12-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/openai/">openai</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/31/Next-chat-web%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98/">Next-chat-web同步</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li>修改docker的环境变量</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHITE_WEBDEV_ENDPOINTS=https://alist.leioukupo.top/机械盘</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在机械盘目录下新建文件夹和文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">机械盘/</span><br><span class="line">└── chatgpt-next-web</span><br><span class="line">    └── backup.json</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置next chat</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 必须启用代理</span></span><br><span class="line"><span class="comment"># 代理地址空着</span></span><br><span class="line">webdev地址 : https://alist.leioukupo.top/dav/机械盘</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2024/12/31/Next-chat-web%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98/" data-id="cm6a108vg0005i4q8dvwvenuw" data-title="Next-chat-web同步" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openai/" rel="tag">openai</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-3588Pve实践" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/28/3588Pve%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time class="dt-published" datetime="2024-12-28T04:44:54.807Z" itemprop="datePublished">2024-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/28/3588Pve%E5%AE%9E%E8%B7%B5/">3588Pve实践</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Rock 5b卖掉后在咸鱼重新入手了一块3588，8+32的配置</p>
</blockquote>
<h1 id="Pve安装"><a href="#Pve安装" class="headerlink" title="Pve安装"></a>Pve安装</h1><p><strong>需要debian系统</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://mirrors.apqa.cn/proxmox/debian/pveport.gpg | sudo <span class="built_in">tee</span> /usr/share/keyrings/pveport.gpg &gt;/dev/null</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [deb=arm64 signed-by=/usr/share/keyrings/pveport.gpg] https://mirrors.apqa.cn/proxmox/debian/pve bookworm port&quot;</span> | sudo <span class="built_in">tee</span>  /etc/apt/sources.list.d/pveport.list</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编辑&#x2F;etc&#x2F;hosts</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">127.0.1.1   yjh-jm10-3588</span><br><span class="line">::1         localhost yjh-jm10-3588 ip6-localhost ip6-loopback</span><br><span class="line">fe00::0     ip6-localnet</span><br><span class="line">ff00::0     ip6-mcastprefix</span><br><span class="line">ff02::1     ip6-allnodes</span><br><span class="line">ff02::2     ip6-allrouters</span><br><span class="line">192.168.31.43 proxmox-server yjh-jm10-3588</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ifupdown2</span><br><span class="line">sudo apt install proxmox-ve postfix open-iscsi pve-edk2-firmware-aarch64</span><br></pre></td></tr></table></figure>

<p>最后要记得重启，在访问ip+8006就可以访问pve管理界面了，密码和账号是root和对应的密码</p>
<h1 id="虚拟机测试"><a href="#虚拟机测试" class="headerlink" title="虚拟机测试"></a>虚拟机测试</h1><p>使用非lxc容器方式</p>
<p>注意点</p>
<ul>
<li>cpu设置要勾选高级选项，在cpu绑定一栏输入 4,5,6,7</li>
<li>无显示输出，需要按照pve官方文档操作</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/jiangcuo/Proxmox-Port/wiki/Install-Proxmox-VE-on-Debian-bookworm">Pve官方文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt download pve-edk2-firmware-aarch64=3.20220526-rockchip</span><br><span class="line">dpkg -i pve-edk2-firmware-aarch64_3.20220526-rockchip_all.deb</span><br></pre></td></tr></table></figure>

<p>如果apt下载失败，复制<a target="_blank" rel="noopener" href="https://mirrors.apqa.cn/proxmox/debian/pve/dists/bookworm/port//binary-arm64/pve-edk2-firmware-aarch64_3.20220526-rockchip_all.deb">pve-edk2</a>到浏览器下载</p>
<p>虚拟机硬件里的显示需要选择ramfb方式</p>
<h2 id="安装istore"><a href="#安装istore" class="headerlink" title="安装istore"></a>安装istore</h2><p>使用虚拟机安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -f raw -O qcow2 istoreos-22.03.7-2024122712-h88k-squashfs-combined.img vm-101-disk-1.qcow2</span><br><span class="line">qm importdisk 101 vm-101-disk-1.qcow2 <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>打开刚才创建的虚拟机的硬件，会看到有个未使用的磁盘，双击打开，点确认即可</p>
<p>对应编辑一下引导顺序。<br><em><strong>启动后，是uefi shell，没有进入istore界面，需要带efi的istore固件</strong></em></p>
<h2 id="lxc运行openwrt"><a href="#lxc运行openwrt" class="headerlink" title="lxc运行openwrt"></a>lxc运行openwrt</h2><p>1.先上传lxc模板，再执行下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pct create 101 \</span><br><span class="line"><span class="built_in">local</span>:vztmpl/rootfs.tar.xz \</span><br><span class="line">--rootfs <span class="built_in">local</span>:1 \</span><br><span class="line">--ostype unmanaged \</span><br><span class="line">--hostname openwrt \</span><br><span class="line">--<span class="built_in">arch</span> arm64 \</span><br><span class="line">--cores 8 \</span><br><span class="line">--memory 1024 \</span><br><span class="line">--swap 0 \</span><br><span class="line">-net0 bridge=vmbr0,name=eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rootfs.tar.xz根据你的lxc模板名字修改</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">101是<span class="built_in">id</span>号</span><br><span class="line"> <span class="built_in">local</span>:1的1是指该lxc容器磁盘大小是1g</span><br><span class="line">memory 运行内存</span><br></pre></td></tr></table></figure>

<p>2.修改lxc容器配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/pve/lxc/101.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">arch</span>: arm64</span><br><span class="line">cores: 8</span><br><span class="line">features: nesting=1</span><br><span class="line">hostname: openwrt</span><br><span class="line">memory: 1024</span><br><span class="line">net0: name=eth0,bridge=vmbr0,hwaddr=BC:24:11:BE:DB:C8,<span class="built_in">type</span>=veth</span><br><span class="line">ostype: unmanaged</span><br><span class="line">rootfs: <span class="built_in">local</span>:101/vm-101-disk-0.raw,size=1G</span><br><span class="line">swap: 0</span><br><span class="line">lxc.mount.entry: /dev/ppp /dev/ppp none <span class="built_in">bind</span>,create=file</span><br><span class="line">lxc.mount.entry: /dev/net/tun /dev/met/tun none <span class="built_in">bind</span>,create=file</span><br></pre></td></tr></table></figure>

<p>3.在pve的web页面找到这个lxc容器，选项—》功能  —-》勾选嵌套</p>
<p>4.启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pct start 101</span><br></pre></td></tr></table></figure>

<p>4.1修改&#x2F;etc&#x2F;config&#x2F;firewall，后面新增</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc-attach 101 </span><br><span class="line"><span class="comment"># 进入op终端，用vi编辑文件</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">config rule</span><br><span class="line">        option name             Allow-Web-WAN</span><br><span class="line">        option src              wan</span><br><span class="line">        option dest_port        443</span><br><span class="line">        option proto            tcp</span><br><span class="line">        option target           ACCEPT</span><br><span class="line">config rule</span><br><span class="line">        option name             Allow-Web-WAN</span><br><span class="line">        option src              wan</span><br><span class="line">        option dest_port        80</span><br><span class="line">        option proto            tcp</span><br><span class="line">        option target           ACCEPT</span><br></pre></td></tr></table></figure>

<p>4.2.重启防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>根据ifconfig显示的ip访问就可以进入后台</p>
<p><a target="_blank" rel="noopener" href="https://virtualizeeverything.com/2022/05/23/setting-openwrt-in-proxmox-lxc/">参考链接</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/lxc-images/images/openwrt/23.05/arm64/default/20241229_11%3A57/">openwrt_lxc模板</a></p>
<h2 id="pve开启ipv6"><a href="#pve开启ipv6" class="headerlink" title="pve开启ipv6"></a>pve开启ipv6</h2><p><a target="_blank" rel="noopener" href="https://www.icn.ink/pve/57.html">https://www.icn.ink/pve/57.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2024/12/28/3588Pve%E5%AE%9E%E8%B7%B5/" data-id="cm6a108vb0001i4q8bwyk4dgc" data-title="3588Pve实践" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PVE/" rel="tag"> PVE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/3588/" rel="tag">3588</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Qt笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/07/04/Qt%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2024-07-04T05:31:38.696Z" itemprop="datePublished">2024-07-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Qt/">Qt</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/07/04/Qt%E7%AC%94%E8%AE%B0/">Qt笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Qt笔记"><a href="#Qt笔记" class="headerlink" title="Qt笔记"></a>Qt笔记</h1><h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><h3 id="自定义信号"><a href="#自定义信号" class="headerlink" title="自定义信号"></a>自定义信号</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sig_addOne</span><span class="params">(<span class="type">int</span> value)</span></span>;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>使用signals声明，返回值是void</p>
</blockquote>
<h3 id="emit—-发送信号"><a href="#emit—-发送信号" class="headerlink" title="emit—-发送信号"></a>emit—-发送信号</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">emit　<span class="title">sig_add</span><span class="params">(socre++)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Qt的子线程无法直接修改ui,需要发送信号到ui线程进行修改</p>
<h2 id="非基础类型参数注册"><a href="#非基础类型参数注册" class="headerlink" title="非基础类型参数注册"></a>非基础类型参数注册</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">qRegisterMetaType</span>&lt;Score&gt;(<span class="string">&quot;Score&quot;</span>);</span><br><span class="line"><span class="built_in">qRegisterMetaType</span>&lt;string&gt;(<span class="string">&quot;string&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="槽函数的参数和信号参数的关系"><a href="#槽函数的参数和信号参数的关系" class="headerlink" title="槽函数的参数和信号参数的关系"></a>槽函数的参数和信号参数的关系</h2><blockquote>
<p>Qt槽函数的参数需要和信号的参数保持一致, 可以比信号的参数少, 但是不能顺序不同, 也不能比信号的参数多</p>
</blockquote>
<h2 id="信号重名如何处理"><a href="#信号重名如何处理" class="headerlink" title="信号重名如何处理"></a>信号重名如何处理</h2><blockquote>
<p>使用泛型解决信号重载问题</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">connect</span>(ui-&gt;comboBox, QOverload&lt;<span class="type">int</span>&gt;::<span class="built_in">of</span>(&amp;QComboBox::currentIndexChanged),</span><br><span class="line">            <span class="keyword">this</span>, &amp;Widget::onIndex);</span><br><span class="line"><span class="built_in">connect</span>(ui-&gt;comboBox, QOverload&lt;<span class="type">const</span> QString&amp;&gt;::<span class="built_in">of</span>(&amp;QComboBox::currentIndexChanged),</span><br><span class="line">            <span class="keyword">this</span>, &amp;Widget::onIndexStr);</span><br></pre></td></tr></table></figure>

<h2 id="信号和槽函数关系"><a href="#信号和槽函数关系" class="headerlink" title="信号和槽函数关系"></a>信号和槽函数关系</h2><blockquote>
<ul>
<li>信号是由对象在某个特定事件发生时发出的消息。信号本身并不执行任何操作，它仅仅是表示某种状态的变化或事件的发生。例如，当一个按钮被点击时，它会发出一个<code>clicked()</code>信号</li>
<li>槽是一个函数，可以接收并处理信号。当一个信号被发出时，与该信号连接的槽函数就会被调用。槽函数可以是任何成员函数、全局函数或lambda表达式</li>
</ul>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2024/07/04/Qt%E7%AC%94%E8%AE%B0/" data-id="cm6a108vi0009i4q8h1uh44lb" data-title="Qt笔记" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Qt/" rel="tag">Qt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ADC" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/04/13/ADC/" class="article-date">
  <time class="dt-published" datetime="2024-04-13T23:35:43.254Z" itemprop="datePublished">2024-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/STM32/">STM32</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/04/13/ADC/">ADC使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="stm32的ADC单通道单次使用"><a href="#stm32的ADC单通道单次使用" class="headerlink" title="stm32的ADC单通道单次使用"></a>stm32的ADC单通道单次使用</h1><h2 id="ADC通道与引脚对应关系"><a href="#ADC通道与引脚对应关系" class="headerlink" title="ADC通道与引脚对应关系"></a>ADC通道与引脚对应关系</h2><p><img src="https://github.com/leioukupo/img/raw/main/Qexo/24/4/image_d766dd94b450b38b8d81a2db02a4d03c.png" alt="adc通道与对应的引脚"><br><strong>stm32f1没有内部温度传感器</strong></p>
<h2 id="单次ADC采集流程"><a href="#单次ADC采集流程" class="headerlink" title="单次ADC采集流程"></a>单次ADC采集流程</h2><blockquote>
<p>1.开启对应时钟和ADC1时钟，设置PA1为模拟输入</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启时钟</span></span><br><span class="line">    <span class="built_in">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_GPIOA, ENABLE); <span class="comment">// GPIOA的时钟定义错误，应就近挂在APB2上，而不能图省事直接挂在AHB上</span></span><br><span class="line">    <span class="built_in">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_ADC1, ENABLE);</span><br><span class="line">    <span class="built_in">RCC_ADCCLKConfig</span>(RCC_PCLK2_Div6); <span class="comment">// 设置ADC时钟，设置ADC分频因子6 72M/6=12,ADC最大时间不能超过14M</span></span><br><span class="line">    <span class="comment">// 初始化GPIO</span></span><br><span class="line">    GPIO_InitTypeDef ADC_PA1;</span><br><span class="line">    ADC_PA1.GPIO_Pin = GPIO_Pin_1;</span><br><span class="line">    ADC_PA1.GPIO_Mode = GPIO_Mode_AIN;<span class="comment">// 模拟输入模式</span></span><br><span class="line">    ADC_PA1.GPIO_Speed = GPIO_Speed_50MHz;<span class="comment">// 50MHz</span></span><br><span class="line">    <span class="built_in">GPIO_Init</span>(GPIOA, &amp;ADC_PA1);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>2.复位ADC1，同时设置ADC1参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ADC_DeInit(ADC1);</span><br><span class="line">    adc1_1.ADC_Mode = ADC_Mode_Independent;// adc工作模式 独立模式</span><br><span class="line">    adc1_1.ADC_ContinuousConvMode = DISABLE;// 连续转换是否开启 </span><br><span class="line">    adc1_1.ADC_DataAlign = ADC_DataAlign_Right;// 数据对齐方式</span><br><span class="line">    adc1_1.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;// 触发转换方式 软件触发</span><br><span class="line">    adc1_1.ADC_ScanConvMode = DISABLE;// 扫描模式是否开启</span><br><span class="line">    adc1_1.ADC_NbrOfChannel = 1;// 转换通道数目</span><br><span class="line">    ADC_Init(ADC1, &amp;adc1_1);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3.使能ADC</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ADC_Cmd</span>(ADC1,ENABLE);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>4.配置规则通道参数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ADC_RegularChannelConfig</span>(ADC1, channel, <span class="number">1</span>, ADC_SampleTime_7Cycles5); <span class="comment">// 通道的转换顺序 如果设置Rank为1</span></span><br><span class="line">                                                                     <span class="comment">//那么这个通道将会首先被转换</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>5.开启软件转换</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ADC_SoftwareStartConvCmd</span>(ADC1,ENABLE); <span class="comment">// 软件触发转换</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>6.等待转换完成，读取ADC值</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ADC_GetConversionValue</span>(ADC1);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2024/04/13/ADC/" data-id="cm6a108vd0002i4q82r359u2v" data-title="ADC使用" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-RTC配置应用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/07/RTC%E9%85%8D%E7%BD%AE%E5%BA%94%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2024-01-07T00:51:22.062Z" itemprop="datePublished">2024-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/07/RTC%E9%85%8D%E7%BD%AE%E5%BA%94%E7%94%A8/">RTC配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="RTC配置应用"><a href="#RTC配置应用" class="headerlink" title="RTC配置应用"></a>RTC配置应用</h1><h2 id="日历配置流程"><a href="#日历配置流程" class="headerlink" title="日历配置流程"></a>日历配置流程</h2><ol>
<li>使能PWR时钟</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RCC_APB1PeriphClockCmd()</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使能后备寄存器访问</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PWR_BackupAccessCmd()</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置RTC时钟源，使能RTC时钟</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RCC_RTCCLKConfig()</span><br><span class="line">RCC_RTCCLKCmd()</span><br><span class="line"># 如果使用LSE    要打开LSE</span><br><span class="line"># RCC_LSEConfig(RCC_LSE_ON)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>初始化RTC(同步&#x2F;异步分频系数和时钟格式)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_Init ()</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置时间</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_SetTime ()</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>设置日期</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_SetDate()</span><br></pre></td></tr></table></figure>

<h2 id="闹钟配置流程"><a href="#闹钟配置流程" class="headerlink" title="闹钟配置流程"></a>闹钟配置流程</h2><ol>
<li>初始化RTC相关参数</li>
<li>关闭闹钟</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_AlarmCmd(RTC_Alarm_A,DISABLE)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置闹钟参数</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_SetAlarm()</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>开启闹钟</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_AlarmCmd(RTC_Alarm_A,EABLE)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>开启配置闹钟中断</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RTC_ITConfig()</span><br><span class="line">EXTI_Init()</span><br><span class="line">NVIC_Init()</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>编写中断服务函数</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_Alarm_IRQHandler()</span><br></pre></td></tr></table></figure>

<h2 id="RTC周期性自动唤醒配置流程"><a href="#RTC周期性自动唤醒配置流程" class="headerlink" title="RTC周期性自动唤醒配置流程"></a>RTC周期性自动唤醒配置流程</h2><ol>
<li>初始化RTC相关参数</li>
<li>关闭WakeUp</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_WakeUpCmd(DISABLE)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置WakeUp时钟分频系数&#x2F;来源</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_WakeUpClockConfig()</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置WakeUp自动装载寄存器</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_SetWakeUpCounter()</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>使能WakeUp</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_WakeUpCmd( ENABLE);</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>开启配置闹钟中断</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RTC_ITConfig()</span><br><span class="line">EXTI_Init()</span><br><span class="line">NVIC_Init()</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>编写中断服务函数</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RTC_WKUP_IRQHandler();</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2024/01/07/RTC%E9%85%8D%E7%BD%AE%E5%BA%94%E7%94%A8/" data-id="cm6a108vj000bi4q89xsygui2" data-title="RTC配置" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Usmart原理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/11/Usmart%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2023-12-11T05:51:53.568Z" itemprop="datePublished">2023-12-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/11/Usmart%E5%8E%9F%E7%90%86/">Usmart</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Usamrt流程"><a href="#Usamrt流程" class="headerlink" title="Usamrt流程"></a>Usamrt流程</h1><h2 id="头文件内容解析"><a href="#头文件内容解析" class="headerlink" title="头文件内容解析"></a>头文件内容解析</h2><ul>
<li>usmart.h—-usmart的主要函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//8个函数函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">usmart_init</span><span class="params">(u8 sysclk)</span>;		<span class="comment">// 初始化</span></span><br><span class="line">u8 <span class="title function_">usmart_cmd_rec</span><span class="params">(u8 *str)</span>;			<span class="comment">// 识别</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">usmart_exe</span><span class="params">(<span class="type">void</span>)</span>;				<span class="comment">// 执行</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">usmart_scan</span><span class="params">(<span class="type">void</span>)</span>;				<span class="comment">// 扫描</span></span><br><span class="line">u32 <span class="title function_">read_addr</span><span class="params">(u32 addr)</span>;			<span class="comment">// 读取指定地址的值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_addr</span><span class="params">(u32 addr, u32 val)</span>; <span class="comment">// 在指定地址写入指定的值</span></span><br><span class="line">u32 <span class="title function_">usmart_get_runtime</span><span class="params">(<span class="type">void</span>)</span>;		<span class="comment">// 获取运行时间</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">usmart_reset_runtime</span><span class="params">(<span class="type">void</span>)</span>;	<span class="comment">// 复位运行时间</span></span><br><span class="line"><span class="comment">//两个结构体</span></span><br><span class="line"><span class="comment">// 函数名列表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">m_usmart_nametab</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">void</span> *func;		<span class="comment">// 函数指针</span></span><br><span class="line">	<span class="type">const</span> u8 *name; <span class="comment">// 函数名(查找串)</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// usmart控制管理器</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">m_usmart_dev</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">m_usmart_nametab</span> *<span class="title">funs</span>;</span> <span class="comment">// 函数名指针</span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> (*init)(u8);		<span class="comment">// 初始化</span></span><br><span class="line">	u8 (*cmd_rec)(u8 *str); <span class="comment">// 识别函数名及参数</span></span><br><span class="line">	<span class="type">void</span> (*exe)(<span class="type">void</span>);		<span class="comment">// 执行</span></span><br><span class="line">	<span class="type">void</span> (*scan)(<span class="type">void</span>);		<span class="comment">// 扫描</span></span><br><span class="line">	u8 fnum;				<span class="comment">// 函数数量</span></span><br><span class="line">	u8 pnum;				<span class="comment">// 参数数量</span></span><br><span class="line">	u8 id;					<span class="comment">// 函数id</span></span><br><span class="line">	u8 sptype;				<span class="comment">// 参数显示类型(非字符串参数):0,10进制;1,16进制;</span></span><br><span class="line">	u16 parmtype;			<span class="comment">// 参数的类型</span></span><br><span class="line">	u8 plentbl[MAX_PARM];	<span class="comment">// 每个参数的长度暂存表</span></span><br><span class="line">	u8 parm[PARM_LEN];		<span class="comment">// 函数的参数</span></span><br><span class="line">	u8 runtimeflag;			<span class="comment">// 0,不统计函数执行时间;1,统计函数执行时间,注意:此功能必须在USMART_ENTIMX_SCAN使能的时候,才有用</span></span><br><span class="line">	u32 runtime;			<span class="comment">// 运行时间,单位:0.1ms,最大延时时间为定时器CNT值的2倍*0.1ms</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//一些变量定义不需要解释</span></span><br></pre></td></tr></table></figure>

<ul>
<li>usmart_str.h—-usmart字符串的相关操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">u8 <span class="title function_">usmart_get_parmpos</span><span class="params">(u8 num)</span>;                                    <span class="comment">// 得到某个参数在参数列里面的起始位置</span></span><br><span class="line">u8 <span class="title function_">usmart_strcmp</span><span class="params">(u8 *str1, u8 *str2)</span>;                             <span class="comment">// 对比两个字符串是否相等</span></span><br><span class="line">u32 <span class="title function_">usmart_pow</span><span class="params">(u8 m, u8 n)</span>;                                       <span class="comment">// M^N次方</span></span><br><span class="line">u8 <span class="title function_">usmart_str2num</span><span class="params">(u8 *str, u32 *res)</span>;                             <span class="comment">// 字符串转为数字</span></span><br><span class="line">u8 <span class="title function_">usmart_get_cmdname</span><span class="params">(u8 *str, u8 *cmdname, u8 *nlen, u8 maxlen)</span>; <span class="comment">// 从str中得到指令名,并返回指令长度</span></span><br><span class="line">u8 <span class="title function_">usmart_get_fname</span><span class="params">(u8 *str, u8 *fname, u8 *pnum, u8 *rval)</span>;      <span class="comment">// 从str中得到函数名</span></span><br><span class="line">u8 <span class="title function_">usmart_get_aparm</span><span class="params">(u8 *str, u8 *fparm, u8 *ptype)</span>;               <span class="comment">// 从str中得到一个函数参数</span></span><br><span class="line">u8 <span class="title function_">usmart_get_fparam</span><span class="params">(u8 *str, u8 *parn)</span>;                          <span class="comment">// 得到str中所有的函数参数.</span></span><br></pre></td></tr></table></figure>

<h3 id="u8-usmart-get-fname"><a href="#u8-usmart-get-fname" class="headerlink" title="u8 usmart_get_fname"></a>u8 usmart_get_fname</h3><blockquote>
<p>pcnt &amp; 0x7f 应该表示第几个参数<br>strtemp每次循环指向一个字符<br>首先判断接收到的字符串前五个字符是不是void, 设置rval, 是不是需要返回值<br>注意! 接收完前五个字符, 记得加’\0’  字符串结束标记, 否则usmart_strcmp无法比较<br>下一个while判断当前字符是不是’*’或者’(‘ , 判断逻辑是, 没有碰到空格或者 * 就继续循环, 同时res也就是offset加1<br>根据offset直接跳到函数名开始的地方<br>继续判断, 逻辑是   fover表示碰到的括号, 左括号加一, 右括号减一,  如果fover是0说明没有接收完, 因为至少有一个左括号或有右括号<br>判断是不是’,’   是,temp加一(temp表示参数个数)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从str中得到函数名</span></span><br><span class="line"><span class="comment">//*str:源字符串指针</span></span><br><span class="line"><span class="comment">//*fname:获取到的函数名字指针</span></span><br><span class="line"><span class="comment">//*pnum:函数的参数个数</span></span><br><span class="line"><span class="comment">//*rval:是否需要显示返回值(0,不需要;1,需要)</span></span><br><span class="line"><span class="comment">// 返回值:0,成功;其他,错误代码</span></span><br><span class="line">u8 <span class="title function_">usmart_get_fname</span><span class="params">(u8 *str, u8 *fname, u8 *pnum, u8 *rval)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 res;</span><br><span class="line">	u8 fover = <span class="number">0</span>; <span class="comment">// 括号深度</span></span><br><span class="line">	u8 *strtemp;</span><br><span class="line">	u8 offset = <span class="number">0</span>;</span><br><span class="line">	u8 parmnum = <span class="number">0</span>;</span><br><span class="line">	u8 temp = <span class="number">1</span>;</span><br><span class="line">	u8 fpname[<span class="number">6</span>];  <span class="comment">// void+X+&#x27;/0&#x27;</span></span><br><span class="line">	u8 fplcnt = <span class="number">0</span>; <span class="comment">// 第一个参数的长度计数器</span></span><br><span class="line">	u8 pcnt = <span class="number">0</span>;   <span class="comment">// 参数计数器</span></span><br><span class="line">	u8 nchar;</span><br><span class="line">	<span class="comment">// 判断函数是否有返回值</span></span><br><span class="line">	strtemp = str;</span><br><span class="line">	<span class="keyword">while</span> (*strtemp != <span class="string">&#x27;\0&#x27;</span>) <span class="comment">// 没有结束</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*strtemp != <span class="string">&#x27; &#x27;</span> &amp;&amp; (pcnt &amp; <span class="number">0X7F</span>) &lt; <span class="number">5</span>) <span class="comment">// 最多记录5个字符</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (pcnt == <span class="number">0</span>)</span><br><span class="line">				pcnt |= <span class="number">0X80</span>; <span class="comment">// 置位最高位,标记开始接收返回值类型   x000 0x00</span></span><br><span class="line">			<span class="keyword">if</span> (((pcnt &amp; <span class="number">0x7f</span>) == <span class="number">4</span>) &amp;&amp; (*strtemp != <span class="string">&#x27;*&#x27;</span>))  <span class="comment">// 0x7f ---&gt; 0111 1111   和0x7f相与查看pcnt是不是等于4    且strtemp此时指向的不是 * </span></span><br><span class="line">				<span class="keyword">break</span>;						<span class="comment">// 就跳出当前这一次循环, 因为最后一个字符,必须是*</span></span><br><span class="line">			fpname[pcnt &amp; <span class="number">0x7f</span>] = *strtemp; <span class="comment">// 记录函数的返回值类型   <span class="doctag">TODO:</span> ?????</span></span><br><span class="line">			pcnt++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (pcnt == <span class="number">0X85</span>)<span class="comment">// 0x85 ---&gt; 1000 0101</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		strtemp++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (pcnt) <span class="comment">// 接收完了</span></span><br><span class="line">	&#123;</span><br><span class="line">		fpname[pcnt &amp; <span class="number">0x7f</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// 加入结束符</span></span><br><span class="line">		<span class="keyword">if</span> (usmart_strcmp(fpname, <span class="string">&quot;void&quot;</span>) == <span class="number">0</span>) <span class="comment">// 看是不是void</span></span><br><span class="line">			*rval = <span class="number">0</span>; <span class="comment">// 不需要返回值</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			*rval = <span class="number">1</span>; <span class="comment">// 需要返回值</span></span><br><span class="line">		pcnt = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	res = <span class="number">0</span>;</span><br><span class="line">	strtemp = str;</span><br><span class="line">	<span class="keyword">while</span> (*strtemp != <span class="string">&#x27;(&#x27;</span> &amp;&amp; *strtemp != <span class="string">&#x27;\0&#x27;</span>) <span class="comment">// 此代码找到函数名的真正起始位置</span></span><br><span class="line">	&#123;</span><br><span class="line">		strtemp++;</span><br><span class="line">		res++;</span><br><span class="line">		<span class="keyword">if</span> (*strtemp == <span class="string">&#x27; &#x27;</span> || *strtemp == <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			nchar = usmart_search_nextc(strtemp); <span class="comment">// 获取下一个字符</span></span><br><span class="line">			<span class="keyword">if</span> (nchar != <span class="string">&#x27;(&#x27;</span> &amp;&amp; nchar != <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">				offset = res; <span class="comment">// 跳过空格和*号</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	strtemp = str;</span><br><span class="line">	<span class="keyword">if</span> (offset)</span><br><span class="line">		strtemp += offset + <span class="number">1</span>; <span class="comment">// 跳到函数名开始的地方</span></span><br><span class="line">	res = <span class="number">0</span>;</span><br><span class="line">	nchar = <span class="number">0</span>; <span class="comment">// 是否正在字符串里面的标志,0，不在字符串;1，在字符串;</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*strtemp == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			res = USMART_FUNCERR; <span class="comment">// 函数错误</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*strtemp == <span class="string">&#x27;(&#x27;</span> &amp;&amp; nchar == <span class="number">0</span>)</span><br><span class="line">			fover++; <span class="comment">// 括号深度增加一级</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*strtemp == <span class="string">&#x27;)&#x27;</span> &amp;&amp; nchar == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (fover)</span><br><span class="line">				fover--;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				res = USMART_FUNCERR; <span class="comment">// 错误结束,没收到&#x27;(&#x27;</span></span><br><span class="line">			<span class="keyword">if</span> (fover == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>; <span class="comment">// 到末尾了,退出</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (*strtemp == <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">			nchar = !nchar;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (fover == <span class="number">0</span>)  <span class="comment">// 已经接受完了函数名了</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (*strtemp != <span class="string">&#x27; &#x27;</span>) <span class="comment">// 空格不属于函数名</span></span><br><span class="line">			&#123;</span><br><span class="line">				*fname = *strtemp; <span class="comment">// 得到函数名</span></span><br><span class="line">				fname++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="comment">// 函数名还没接收完</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (*strtemp == <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp = <span class="number">1</span>; <span class="comment">// 使能增加一个参数</span></span><br><span class="line">				pcnt++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (*strtemp != <span class="string">&#x27; &#x27;</span> &amp;&amp; *strtemp != <span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (pcnt == <span class="number">0</span> &amp;&amp; fplcnt &lt; <span class="number">5</span>) <span class="comment">// 当第一个参数来时,为了避免统计void类型的参数,必须做判断.  void(超过5了,所以定为5</span></span><br><span class="line">				&#123;</span><br><span class="line">					fpname[fplcnt] = *strtemp; <span class="comment">// 记录参数特征</span></span><br><span class="line">					fplcnt++;</span><br><span class="line">				&#125;</span><br><span class="line">				temp++; <span class="comment">// 得到有效参数(非空格)</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (fover == <span class="number">1</span> &amp;&amp; temp == <span class="number">2</span>) <span class="comment">// <span class="doctag">TODO:</span>没懂？？？</span></span><br><span class="line">			&#123;</span><br><span class="line">				temp++;	   <span class="comment">// 防止重复增加</span></span><br><span class="line">				parmnum++; <span class="comment">// 参数增加一个</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		strtemp++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (parmnum == <span class="number">1</span>) <span class="comment">// 只有1个参数.</span></span><br><span class="line">	&#123;</span><br><span class="line">		fpname[fplcnt] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// 加入结束符</span></span><br><span class="line">		<span class="keyword">if</span> (usmart_strcmp(fpname, <span class="string">&quot;void&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			parmnum = <span class="number">0</span>; <span class="comment">// 参数为void,表示没有参数.</span></span><br><span class="line">	&#125;</span><br><span class="line">	*pnum = parmnum; <span class="comment">// 记录参数个数</span></span><br><span class="line">	*fname = <span class="string">&#x27;\0&#x27;</span>;	 <span class="comment">// 加入结束符</span></span><br><span class="line">	<span class="keyword">return</span> res;		 <span class="comment">// 返回执行结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="u8-usmart-strcmp-u8-str1-u8-str2"><a href="#u8-usmart-strcmp-u8-str1-u8-str2" class="headerlink" title="u8 usmart_strcmp(u8 *str1, u8 *str2)"></a>u8 usmart_strcmp(u8 *str1, u8 *str2)</h3><blockquote>
<p>比较两个字符串是不是一样, 和strcmp类似</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">u8 <span class="title function_">usmart_strcmp</span><span class="params">(u8 *str1, u8 *str2)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*str1 != *str2)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 不相等</span></span><br><span class="line">		<span class="keyword">if</span> (*str1 == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">			<span class="keyword">break</span>; <span class="comment">// 对比完成了.</span></span><br><span class="line">		str1++;</span><br><span class="line">		str2++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 两个字符串相等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="u8-usmart-search-nextc-u8-str"><a href="#u8-usmart-search-nextc-u8-str" class="headerlink" title="u8 usmart_search_nextc(u8 *str)"></a>u8 usmart_search_nextc(u8 *str)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取下一个字符（当中间有很多空格的时候，此函数直接忽略空格，找到空格之后的第一个字符）</span></span><br><span class="line"><span class="comment">// str:字符串指针</span></span><br><span class="line"><span class="comment">// 返回值:下一个字符</span></span><br><span class="line">u8 <span class="title function_">usmart_search_nextc</span><span class="params">(u8 *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	str++;</span><br><span class="line">	<span class="keyword">while</span> (*str == <span class="string">&#x27; &#x27;</span> &amp;&amp; str != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">		str++;</span><br><span class="line">	<span class="keyword">return</span> *str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="usmart-init—-初始化"><a href="#usmart-init—-初始化" class="headerlink" title="usmart_init—-初始化"></a>usmart_init—-初始化</h3><blockquote>
<p>初始化定时器, 使用的是定时器4, 主频也就是sysclk是72mhz, sysclk<em>100-1是分频系数—&gt; 72000000&#x2F;(72 * 100-1 +1 )&#x3D;10000hz, 所以一个定时器周期是1&#x2F;10000&#x3D;&#x3D;0.0001s&#x3D;&#x3D;0.1ms, 定时器0.1ms</em>1000&#x3D;&#x3D;&#x3D;&#x3D;100ms中断一次</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Timer4_Init(<span class="number">1000</span>, (u32)sysclk * <span class="number">100</span> - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="usmart-cmd-rec—-识别"><a href="#usmart-cmd-rec—-识别" class="headerlink" title="usmart_cmd_rec—-识别"></a>usmart_cmd_rec—-识别</h3><blockquote>
<p>usmart_cmd_rec函数逻辑<br>入口参数是从串口接收到的函数名字, 字符串指针<br>首先通过usmart_get_fname得到函数名字和参数个数<br>然后从0到usmart_dev.fnum(结构体里函数数量值)开始循环, strcmp逐个比较接收的函数名字和本地存储的函数名字<br>情况1. 如果找到一样的，判断收到的函数参数是不是和存储的函数参数个数相等<br>情况1.1 收到的小于存储的就返回错误<strong>USMART_PARMERR</strong>, 记下函数id, 跳出循环<br>情况1.2 收到的大于存储的,     xxxxxxxxxxx<br>情况1.3 收到的等于存储的, 用usmart_get_fparam获得函数参数个数并赋值给usmart_dev.pnum<br>情况3. 如果i循环到等于usmart_dev.fnum, 也就是全部找完了, 没有发现符合的函数名字,也返回一个错误<strong>USMART_NOFUNCFIND</strong><br>都判断完,找到了且参数个数也一样就返回<strong>USMART_OK</strong></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//入口参数是字符串指针</span></span><br><span class="line">u8 <span class="title function_">usmart_cmd_rec</span><span class="params">(u8 *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 sta, i, rval; <span class="comment">// 状态</span></span><br><span class="line">	u8 rpnum, spnum;</span><br><span class="line">	u8 rfname[MAX_FNAME_LEN];							<span class="comment">// 暂存空间,用于存放接收到的函数名</span></span><br><span class="line">	u8 sfname[MAX_FNAME_LEN];							<span class="comment">// 存放本地函数名</span></span><br><span class="line">	sta = usmart_get_fname(str, rfname, &amp;rpnum, &amp;rval); <span class="comment">// 得到接收到的数据的函数名及参数个数</span></span><br><span class="line">	<span class="keyword">if</span> (sta)</span><br><span class="line">		<span class="keyword">return</span> sta; <span class="comment">// 错误</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; usmart_dev.fnum; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		sta = usmart_get_fname((u8 *)usmart_dev.funs[i].name, sfname, &amp;spnum, &amp;rval); <span class="comment">// 得到本地函数名及参数个数</span></span><br><span class="line">		<span class="keyword">if</span> (sta)</span><br><span class="line">			<span class="keyword">return</span> sta;							<span class="comment">// 本地解析有误</span></span><br><span class="line">		<span class="keyword">if</span> (usmart_strcmp(sfname, rfname) == <span class="number">0</span>) <span class="comment">// 相等</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (spnum &gt; rpnum)</span><br><span class="line">				<span class="keyword">return</span> USMART_PARMERR; <span class="comment">// 参数错误(输入参数比源函数参数少)</span></span><br><span class="line">			usmart_dev.id = i;		   <span class="comment">// 记录函数ID.</span></span><br><span class="line">			<span class="keyword">break</span>;					   <span class="comment">// 跳出.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (i == usmart_dev.fnum)</span><br><span class="line">		<span class="keyword">return</span> USMART_NOFUNCFIND;	  <span class="comment">// 未找到匹配的函数</span></span><br><span class="line">	sta = usmart_get_fparam(str, &amp;i); <span class="comment">// 得到函数参数个数</span></span><br><span class="line">	<span class="keyword">if</span> (sta)</span><br><span class="line">		<span class="keyword">return</span> sta;		 <span class="comment">// 返回错误</span></span><br><span class="line">	usmart_dev.pnum = i; <span class="comment">// 参数个数记录</span></span><br><span class="line">	<span class="keyword">return</span> USMART_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从str中得到函数名</span></span><br><span class="line"><span class="comment">//*str:源字符串指针</span></span><br><span class="line"><span class="comment">//*fname:获取到的函数名字指针</span></span><br><span class="line"><span class="comment">//*pnum:函数的参数个数</span></span><br><span class="line"><span class="comment">//*rval:是否需要显示返回值(0,不需要;1,需要)</span></span><br><span class="line"><span class="comment">// 返回值:0,成功;其他,错误代码</span></span><br><span class="line">u8 <span class="title function_">usmart_get_fname</span><span class="params">(u8 *str, u8 *fname, u8 *pnum, u8 *rval)</span></span><br></pre></td></tr></table></figure>

<h3 id="usmart-exe—-执行"><a href="#usmart-exe—-执行" class="headerlink" title="usmart_exe—-执行"></a>usmart_exe—-执行</h3><h3 id="usmart-scan—-扫描"><a href="#usmart-scan—-扫描" class="headerlink" title="usmart_scan—-扫描"></a>usmart_scan—-扫描</h3><h3 id="整体逻辑"><a href="#整体逻辑" class="headerlink" title="整体逻辑"></a>整体逻辑</h3><ol>
<li>初始化定时器四, 0.1ms产生一次中断, 执行usmart_scan进行扫描</li>
<li>扫描成功后执行usmart_cmd_rec识别接收的字符串</li>
<li>识别成功后执行usmart_exe运行函数</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2023/12/11/Usmart%E5%8E%9F%E7%90%86/" data-id="cm6a108vl000di4q81pw3fhdm" data-title="Usmart" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-FSMC" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/09/FSMC/" class="article-date">
  <time class="dt-published" datetime="2023-12-09T23:43:59.244Z" itemprop="datePublished">2023-12-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/09/FSMC/">FSMC</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="FSMC—-灵活的静态存储控制器"><a href="#FSMC—-灵活的静态存储控制器" class="headerlink" title="FSMC—-灵活的静态存储控制器"></a>FSMC—-灵活的静态存储控制器</h1><blockquote>
<p>能够与同步或异步存储器和16位PC存储器卡连接，STM32的FSMC接口支持包括 <code>SRAM</code>、<code>NANDFLASH</code>、<code>NORFLASH</code>和 <code>PSRAM</code>等存储器，支持8&#x2F;16&#x2F;32&#x2F;位数据宽度。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/leioukupo/img/main/fsmc.png" alt="fsmc框图"></p>
<p>fsmc驱动LCD的原理——-&gt;nor存储控制器把TFTLCD当成一个SRAM来用，有两个地址的SRAM</p>
<p><img src="https://raw.githubusercontent.com/leioukupo/img/main/FSMC%E5%AD%98%E5%82%A8%E5%9D%97.png" alt="fsmc存储块"></p>
<p>！注意：</p>
<blockquote>
<p>当Bank1接的是16位宽度存储器的时候：HADDR[25:1]-&gt;FSMC_A[24:0]；</p>
<p>当Bank1接的是8位宽度存储器的时候：HADDR[25:0]-&gt;FSMC_A[25:0]；</p>
<p>不论外部接8位&#x2F;16位宽设备，FSMC_A[0]永远接在外部设备地址A[0]。</p>
</blockquote>
<p><strong>STM32F4仅写时序DATAST需要+1</strong></p>
<p><strong>SRAM模式A</strong></p>
<p><img src="https://raw.githubusercontent.com/leioukupo/img/main/FSMC-SRAM.png" alt="模式A"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LCD地址结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    vu16 LCD_REG; <span class="comment">// 0110 1100 0000 0000 0000 0111 1111 1110</span></span><br><span class="line">    vu16 LCD_RAM; <span class="comment">//0110 1100 0000 0000 0000 1000 0000 0000    16进制+1---&gt;8进制加2</span></span><br><span class="line">&#125; LCD_TypeDef;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用NOR/SRAM的 Bank1.sector4,地址位HADDR[27,26]=11 A10作为数据命令区分线 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD_BASE        ((u32)(0x6C000000 | 0x000007FE))</span></span><br><span class="line"><span class="comment">//注意当Bank1接的是16位宽度存储器的时候：HADDR[25:1] ---&gt; FSMC_A[24:0]</span></span><br><span class="line"><span class="comment">//右移一位对齐，对应到地址引脚即A10:A0 --- &gt; 0011 1111 1110     A10是 0</span></span><br><span class="line"><span class="comment">//0x6C000000 ---&gt; 0110 1100 0000 0000 0000 0000 0000 0000  </span></span><br><span class="line"><span class="comment">//0x000007FE ---&gt; 0000 0000 0000 0000 0000 0111 1111 1110</span></span><br><span class="line"><span class="comment">//相与的结果</span></span><br><span class="line"><span class="comment">//                            0110 1100 0000 0000 0000 0111 1111 1110</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD             ((LCD_TypeDef *) LCD_BASE)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LCD_BASE，根据外部电路的连接来确定，如Bank1.sector4就是从地址<span class="number">0X6C000000</span>开始，而<span class="number">0X000007FE</span>，则是A10的偏移量</span><br><span class="line"><span class="number">7F</span>E ---&gt; <span class="number">0111</span> <span class="number">1111</span> <span class="number">1110</span></span><br><span class="line"><span class="number">16</span>位数据，地址右移一位对齐，对应到地址引脚  ---&gt; <span class="number">0011</span> <span class="number">1111</span> <span class="number">1111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LCD  ((LCD_TypeDef *) LCD_BASE)强制转换后，LCD_REG---&gt; 0110 1100 0000 0000 0000 0111 1111 1110  </span></span><br><span class="line">对应到A10是<span class="number">0</span>，<span class="number">16</span>位+<span class="number">1</span>即<span class="number">8</span>位加<span class="number">2</span>  得到<span class="number">0110</span> <span class="number">1100</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0000</span>  A10是<span class="number">1</span>  </span><br><span class="line">从而实现对RS的控制</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2023/12/09/FSMC/" data-id="cm6a108vf0004i4q87ejq38dn" data-title="FSMC" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-c语言位运算在单片机的应用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/07/c%E8%AF%AD%E8%A8%80%E4%BD%8D%E8%BF%90%E7%AE%97%E5%9C%A8%E5%8D%95%E7%89%87%E6%9C%BA%E7%9A%84%E5%BA%94%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2023-12-07T05:56:37.591Z" itemprop="datePublished">2023-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/07/c%E8%AF%AD%E8%A8%80%E4%BD%8D%E8%BF%90%E7%AE%97%E5%9C%A8%E5%8D%95%E7%89%87%E6%9C%BA%E7%9A%84%E5%BA%94%E7%94%A8/">c语言位运算</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="按位与运算"><a href="#按位与运算" class="headerlink" title="按位与运算 &amp;"></a>按位与运算 &amp;</h1><p><code>&amp;0</code>是屏蔽该位(使该位清0)，<code>&amp;1</code>是该位不变</p>
<p>常用来查看或分离某一位的值</p>
<p>举例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TIM2ch1_cap_sta&amp;<span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"># <span class="number">0x40</span>  <span class="number">0100</span> <span class="number">0000</span></span><br><span class="line"># 第七位是捕获到高电平标志位,和<span class="number">0x40</span>&amp;就是为了查看TIM2ch1_cap_sta第七位是不是<span class="number">1</span>，是不是捕获到了高电平</span><br></pre></td></tr></table></figure>

<h1 id="按位或运算"><a href="#按位或运算" class="headerlink" title="按位或运算 |"></a>按位或运算 |</h1><p><code>|0</code>是不变，<code>|1</code>是置1</p>
<p>常用来把某一位设置为1</p>
<p>举例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TIM2ch1_cap_sta |= <span class="number">0x80</span>;</span><br><span class="line"># <span class="number">0x80</span>  <span class="number">1000</span> <span class="number">0000</span></span><br><span class="line"># 时间太长了无法计数了，强制拔第八位置<span class="number">1</span>,使这次捕获完成</span><br></pre></td></tr></table></figure>

<h1 id="按位异或"><a href="#按位异或" class="headerlink" title="按位异或 ^"></a>按位异或 ^</h1><p><code>^0</code>是不变，<code>^1</code>是反转</p>
<p>常用来反转某一位的值，比如把0变成1，1变成0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span> <span class="number">1111</span> &amp; <span class="number">0000</span> <span class="number">0011</span> = <span class="number">0000</span> <span class="number">0011</span></span><br><span class="line"># <span class="number">1111</span>的前两位被翻转为<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="异或运算的四条性质"><a href="#异或运算的四条性质" class="headerlink" title="异或运算的四条性质"></a>异或运算的四条性质</h2><ol>
<li><p><strong>任意一个变量X与其自身进行异或运算，结果为0，即X^X&#x3D;0</strong></p>
</li>
<li><p><strong>任意一个变量X与0进行异或运算，结果不变，即X^0&#x3D;X</strong></p>
</li>
<li><p><strong>异或运算具有可结合性，即a^b^c&#x3D;(a^b)^c&#x3D;a^(b^c)</strong></p>
</li>
<li><p><strong>异或运算具有可交换性，即a^b&#x3D;b^a</strong></p>
</li>
</ol>
<h1 id="左移"><a href="#左移" class="headerlink" title="左移 &lt;&lt;"></a>左移 &lt;&lt;</h1><p>向左移动相应的位数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> &lt;&lt; <span class="number">1</span>  ----&gt; </span><br><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h1 id="右移"><a href="#右移" class="headerlink" title="右移 &gt;&gt;"></a>右移 &gt;&gt;</h1><p>向右移动相应的位数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span>  &gt;&gt; <span class="number">1</span>     ----&gt;</span><br><span class="line"><span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="综合运用举例"><a href="#综合运用举例" class="headerlink" title="综合运用举例"></a>综合运用举例</h1><h2 id="设置寄存器的值"><a href="#设置寄存器的值" class="headerlink" title="设置寄存器的值"></a>设置寄存器的值</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GPIOA -&gt; CRL &amp;= <span class="number">0XFFFFFF0F</span>;<span class="comment">// 将第 4-7 位清 0</span></span><br><span class="line">GPIOA -&gt; CRL |= <span class="number">0X00000040</span>;<span class="comment">// 设置相应位的值，且不改变其他位的值</span></span><br></pre></td></tr></table></figure>

<h2 id="移位操作提高代码可读性"><a href="#移位操作提高代码可读性" class="headerlink" title="移位操作提高代码可读性"></a>移位操作提高代码可读性</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GPIOx -&gt; BSRR = (((<span class="type">uint32_t</span>)<span class="number">0x01</span>) &lt;&lt; pinpos);</span><br><span class="line"># <span class="number">0x01</span>     <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line"># 这行代码可以直观明了的知道，是将第 pinpos 位设置为 <span class="number">1</span></span><br><span class="line">GPIOA -&gt; ORT |= <span class="number">1</span>&lt;&lt;<span class="number">5</span>;<span class="comment">// PA.5 输出高，不改变其他位</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.leioukupo.top/2023/12/07/c%E8%AF%AD%E8%A8%80%E4%BD%8D%E8%BF%90%E7%AE%97%E5%9C%A8%E5%8D%95%E7%89%87%E6%9C%BA%E7%9A%84%E5%BA%94%E7%94%A8/" data-id="cm6a108vm000gi4q8dg75hxhr" data-title="c语言位运算" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" rel="tag">单片机</a></li></ul>

    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/STM32/">STM32</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/openai/">openai</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pve/">pve</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/PVE/" rel="tag"> PVE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/3588/" rel="tag">3588</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt/" rel="tag">Qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STM32/" rel="tag">STM32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openai/" rel="tag">openai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pve/" rel="tag">pve</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" rel="tag">单片机</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/PVE/" style="font-size: 10px;"> PVE</a> <a href="/tags/3588/" style="font-size: 10px;">3588</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/Qt/" style="font-size: 10px;">Qt</a> <a href="/tags/STM32/" style="font-size: 20px;">STM32</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/openai/" style="font-size: 10px;">openai</a> <a href="/tags/pve/" style="font-size: 10px;">pve</a> <a href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" style="font-size: 10px;">单片机</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/01/24/PVE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/">PVE备份与恢复</a>
          </li>
        
          <li>
            <a href="/2024/12/31/Next-chat-web%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98/">Next-chat-web同步</a>
          </li>
        
          <li>
            <a href="/2024/12/28/3588Pve%E5%AE%9E%E8%B7%B5/">3588Pve实践</a>
          </li>
        
          <li>
            <a href="/2024/07/04/Qt%E7%AC%94%E8%AE%B0/">Qt笔记</a>
          </li>
        
          <li>
            <a href="/2024/04/13/ADC/">ADC使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 leioukupo<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>